<!DOCTYPE html>  <html> <head>   <title>fontbomb.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> <script type="text/javascript">   if (window.location.hostname != '6a68.net') { return; }    var _gaq = _gaq || [];   _gaq.push(['_setAccount', 'UA-32602307-1']);   _gaq.push(['_trackPageview']);    (function() {     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);   })();  </script> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="code-equals-data-equals-code.html">                 code-equals-data-equals-code.js               </a>                                           <a class="source" href="fontbomb.html">                 fontbomb.js               </a>                                           <a class="source" href="frontend-architecture-patterns.html">                 frontend-architecture-patterns.js               </a>                                           <a class="source" href="functional-programming.html">                 functional-programming.js               </a>                                           <a class="source" href="index.html">                 index.js               </a>                                           <a class="source" href="interview-problems-dependency-manager.html">                 interview-problems-dependency-manager.js               </a>                                           <a class="source" href="js-flow-control.html">                 js-flow-control.js               </a>                                           <a class="source" href="meebo-jquery.html">                 meebo-jquery.js               </a>                                           <a class="source" href="reentrant-exceptions.html">                 reentrant-exceptions.js               </a>                                           <a class="source" href="rsvp.html">                 rsvp.js               </a>                                           <a class="source" href="theres-a-bluebird-in-my-heart.html">                 theres-a-bluebird-in-my-heart.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Annotated look at <a href="http://fontbomb.ilex.ca">fontbomb.ilex.ca</a>, some awfully well-written code that
I heard about from <a href="http://twitter.com/#!/tobinibot">@tobinibot</a> and really enjoyed reading.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>All these annotations are mine. I don't know the author, so it's possible
I won't catch all the subtleties. For reference, the author is <a href="http://twitter.com/#!/plehoux">@plehoux</a>,
and I prettied up the code using <a href="http://jsbeautifier.org">jsbeautifier.org</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Why bother? Um, well, I dunno. I haven't done code reviews in a while, and
it was just fun to read, and my pre-front end coding self would probably
have found this code semi-bewildering to read, yet the animations so enticing and cool.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>on to the codez...</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>wrap in a function expression to avoid polluting underlying page</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>declare stuff visible at top level</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">Bomb</span><span class="p">,</span> <span class="nx">Explosion</span><span class="p">,</span> <span class="nx">Particle</span><span class="p">,</span> <span class="nx">targetTime</span><span class="p">,</span> <span class="nx">vendor</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>pretty standard bind function used for callbacking</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">__bind</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">me</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
            <span class="p">};</span>
        <span class="p">};</span>

    <span class="nx">w</span> <span class="o">=</span> <span class="nb">window</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Hm, so I think there is probably a bug here, now that I'm looking closely. 
We try to loop over the different vendor prefixes to find out which prefixed
requestAnimationFrame method is defined (so, window.mozRequestAnimationFrame
vs. window.webkitRequestAnimationFrame),</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_ref</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;moz&#39;</span><span class="p">,</span> <span class="s1">&#39;webkit&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">_ref</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">vendor</span> <span class="o">=</span> <span class="nx">_ref</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>but here, we don't actually append the vendor variable to the string,
we just look for a property named "vendorRequestAnimationFrame" on window.
Actually, we look for an element with an ID of "vendorRequestAnimationFrame"
so I think this should always evaluate to undefined--which is okay,
because it just means you fall back to setTimeout/clearTimeout below.
I think this would work if they had done "w[vendor + 'RequestAnimationFrame']"</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">w</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">=</span> <span class="nx">w</span><span class="p">[</span><span class="s2">&quot;#vendorRequestAnimationFrame&quot;</span><span class="p">];</span>
        <span class="nx">w</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span> <span class="o">=</span> <span class="nx">w</span><span class="p">[</span><span class="s2">&quot;#vendorCancelAnimationFrame&quot;</span><span class="p">]</span> <span class="o">||</span> <span class="nx">w</span><span class="p">[</span><span class="s2">&quot;#vendorCancelRequestAnimationFrame&quot;</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="nx">targetTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>so, if requestAnimationFrame wasn't found, create a function that sets a short timeout:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">w</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">||</span> <span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">currentTime</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>set the next timeout to the larger of targetTime plus 16 msec or
the current time coerced to an integer with '+'</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">targetTime</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">targetTime</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="nx">currentTime</span> <span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>then set a timeout which fires the callback after the next tick,
and passes the time to the callback (so the callback code can calculate
the elapsed time), and return the timeout ID so it can be canceled</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">((</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="o">+</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">));</span>
        <span class="p">}),</span> <span class="nx">targetTime</span> <span class="o">-</span> <span class="nx">currentTime</span><span class="p">);</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>same sort of thing: if cancelAnimationFrame wasn't found, use clearTimeout
as fallback.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">w</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span> <span class="o">||</span> <span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>cross-browser method to find click coordinates from click event, or
global event object on IE</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">w</span><span class="p">.</span><span class="nx">findClickPos</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posx</span><span class="p">,</span> <span class="nx">posy</span><span class="p">;</span>
        <span class="nx">posx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">posy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">e</span><span class="p">)</span> <span class="nx">e</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">posx</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">;</span>
            <span class="nx">posy</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">posx</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">;</span>
            <span class="nx">posy</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">posx</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">posy</span>
        <span class="p">};</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>get element offset by recursively getting offsets of positioned ancestors</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">w</span><span class="p">.</span><span class="nx">getOffset</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">_x</span><span class="p">,</span> <span class="nx">_y</span><span class="p">;</span>
        <span class="nx">body</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>while the element isn't null, and while its offsets are not undefined,</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">while</span> <span class="p">(</span><span class="nx">el</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>get the position by subtracting the element's document coordinates
from the distance the element is scrolled,</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">_x</span> <span class="o">+=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">-</span> <span class="nx">el</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">;</span>
            <span class="nx">_y</span> <span class="o">+=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">offsetTop</span> <span class="o">-</span> <span class="nx">el</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>then go up to the next positioned ancestor.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">el</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">top</span><span class="o">:</span> <span class="nx">_y</span> <span class="o">+</span> <span class="nx">body</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">,</span>
            <span class="nx">left</span><span class="o">:</span> <span class="nx">_x</span> <span class="o">+</span> <span class="nx">body</span><span class="p">.</span><span class="nx">scrollLeft</span>
        <span class="p">};</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>configure the constructor and prototype methods, then return the constructor.
this is a nice, clean way to group the code.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Particle</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>setting some instance properties in the constructor,</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">Particle</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">elem</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">style</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;zIndex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9999</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">transformX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">transformY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">transformRotation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">offsetTop</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getOffset</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">).</span><span class="nx">top</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getOffset</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">elem</span><span class="p">).</span><span class="nx">left</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">velocityX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">velocityY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>then defining shared methods by appending to prototype.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>on tick, given a 'blast' parameter with I'm guessing blast coordinates,</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Particle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">tick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">blast</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">distX</span><span class="p">,</span> <span class="nx">distXS</span><span class="p">,</span> <span class="nx">distY</span><span class="p">,</span> <span class="nx">distYS</span><span class="p">,</span> <span class="nx">distanceWithBlast</span><span class="p">,</span> <span class="nx">force</span><span class="p">,</span> <span class="nx">forceX</span><span class="p">,</span> <span class="nx">forceY</span><span class="p">,</span> <span class="nx">previousRotation</span><span class="p">,</span> <span class="nx">previousStateX</span><span class="p">,</span> <span class="nx">previousStateY</span><span class="p">,</span> <span class="nx">rad</span><span class="p">,</span> <span class="nx">transform</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>get the last position of this particle</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">previousStateX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformX</span><span class="p">;</span>
            <span class="nx">previousStateY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformY</span><span class="p">;</span>
            <span class="nx">previousRotation</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformRotation</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>if the velocity was big enough, pull it towards zero,</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">velocityX</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">velocityX</span> <span class="o">-=</span> <span class="mf">1.5</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">velocityX</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">velocityX</span> <span class="o">+=</span> <span class="mf">1.5</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>otherwise, if it's between -1.5 and 1.5, null it out.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">velocityX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>ditto for y velocity.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">velocityY</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">velocityY</span> <span class="o">-=</span> <span class="mf">1.5</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">velocityY</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">velocityY</span> <span class="o">+=</span> <span class="mf">1.5</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">velocityY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>if there was a new blast, add it to the existing forces on the particle.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">blast</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>figure out blast distance from particle</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">distX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformX</span> <span class="o">-</span> <span class="nx">blast</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
                <span class="nx">distY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">offsetTop</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformY</span> <span class="o">-</span> <span class="nx">blast</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>to make it look like stuff scattered by a bomb, use an
inverse square law for the force relation: the force is
proportional to 1 over distance squared. Ignore the bilinear term
in (a+b)^2 = a^2 + b^2 + 2ab. yay physics.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">distXS</span> <span class="o">=</span> <span class="nx">distX</span> <span class="o">*</span> <span class="nx">distX</span><span class="p">;</span>
                <span class="nx">distYS</span> <span class="o">=</span> <span class="nx">distY</span> <span class="o">*</span> <span class="nx">distY</span><span class="p">;</span>
                <span class="nx">distanceWithBlast</span> <span class="o">=</span> <span class="nx">distXS</span> <span class="o">+</span> <span class="nx">distYS</span><span class="p">;</span>
                <span class="nx">force</span> <span class="o">=</span> <span class="mi">100000</span> <span class="o">/</span> <span class="nx">distanceWithBlast</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>if the force is really huge, cap it at 50</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">force</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="nx">force</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>convert the force into x- and y-direction pieces</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">rad</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">(</span><span class="nx">distYS</span> <span class="o">/</span> <span class="nx">distanceWithBlast</span><span class="p">);</span>
                <span class="nx">forceY</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">rad</span><span class="p">)</span> <span class="o">*</span> <span class="nx">force</span> <span class="o">*</span> <span class="p">(</span><span class="nx">distY</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
                <span class="nx">forceX</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">rad</span><span class="p">)</span> <span class="o">*</span> <span class="nx">force</span> <span class="o">*</span> <span class="p">(</span><span class="nx">distX</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>and append the force to whatever the particle's velocity was
in the previous tick</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">velocityX</span> <span class="o">=</span> <span class="o">+</span><span class="nx">forceX</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">velocityY</span> <span class="o">=</span> <span class="o">+</span><span class="nx">forceY</span><span class="p">;</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>ok, now we add the new velocity to the old transform params and set the rotation</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">transformX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformX</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">velocityX</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">transformY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformY</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">velocityY</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">transformRotation</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformX</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>if the changes were really small, bail. else, update the transform.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">previousStateX</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformX</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">previousStateY</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">previousRotation</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformRotation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">transformX</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformX</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">transformY</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformY</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
                <span class="nx">transform</span> <span class="o">=</span> <span class="s2">&quot;translate(&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformX</span> <span class="o">+</span> <span class="s2">&quot;px, &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformY</span> <span class="o">+</span> <span class="s2">&quot;px) rotate(&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">transformRotation</span> <span class="o">+</span> <span class="s2">&quot;deg)&quot;</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;MozTransform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">transform</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;WebkitTransform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">transform</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;msTransform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">transform</span><span class="p">;</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">transform</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>finally, return the prepared constructor function.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">Particle</span><span class="p">;</span>

    <span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>the particle constructor is so far only available inside the current
self-executing function scope; make it available on the window</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">Particle</span> <span class="o">=</span> <span class="nx">Particle</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>same deal with the Bomb constructor: looks like we'll set up the constructor
and the prototype methods, then return the constructor function, keeping all
the code nicely grouped together inside a self-execution function.</p>

<p>Bomb is actually the DOM node that shows the countdown, so we'll probably see
some DOM wrangling here.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Bomb</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>I'm guessing size of the bomb image in pixels</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Bomb</span><span class="p">.</span><span class="nx">SIZE</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

        <span class="kd">function</span> <span class="nx">Bomb</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>I confess I'm not sure why you'd need to bind own functions to an object,
unless you just don't want to have to explicitly pass __bind(this.foo,this)
into callbacks. I don't personally like hiding the closing-over, but whatev,
probably a stylistic thing.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">countDown</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">countDown</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">drop</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">drop</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>set the bomb's position</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span>
                <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span>
            <span class="p">};</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>set the bomb to its initial state and countdown to initial count</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;planted&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>then "drop" the bomb to start ticking</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">drop</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nx">Bomb</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drop</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>create a div with the count inside it,</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>append it to the DOM right away; probably should have waited
to set properties on the bomb before appending, as each of
these CSS changes will have a DOM update cost. could also just
set them all at once using body.style.cssText.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;zIndex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;9999&quot;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;fontFamily&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;verdana&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>yeah, looks like the SIZE constant is used to set the bomb's size</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">Bomb</span><span class="p">.</span><span class="nx">SIZE</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">Bomb</span><span class="p">.</span><span class="nx">SIZE</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;display&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>how's it round? the border radius equals the diameter. clever.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;borderRadius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">Bomb</span><span class="p">.</span><span class="nx">SIZE</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;WebkitBorderRadius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">Bomb</span><span class="p">.</span><span class="nx">SIZE</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;MozBorderRadius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">Bomb</span><span class="p">.</span><span class="nx">SIZE</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;fontSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;18px&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#fff&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;lineHeight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">Bomb</span><span class="p">.</span><span class="nx">SIZE</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#000&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;absolute&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>center it at the click point</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">Bomb</span><span class="p">.</span><span class="nx">SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">Bomb</span><span class="p">.</span><span class="nx">SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;textAlign&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;center&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>make it unselectable in webkit only, odd. maybe a touch event thing?</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;WebkitUserSelect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;font-weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">700</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>after a second, fire countDown</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">countDown</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>1 sec after the bomb is planted, this gets fired. this
also gets fired recursively until the count runs out.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Bomb</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">countDown</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>set the state to 'ticking'</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;ticking&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>decrement the count</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">count</span><span class="o">--</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>put the new count number inside the DOM so users can see it</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>if the count hasn't run out, wait another second then do this again</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">countDown</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>otherwise, "explose"</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">explose</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>when you "explose", get rid of the number and toggle state to 'explose'.
what's that do? grepping down the file, it looks like Explosion.prototype.tick
checks the bomb's state and does stuff if the 'explose' state happens.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Bomb</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">explose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;explose&#39;</span><span class="p">;</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>oh, so if Explosion.prototype.tick finds that the state is 'explose', it
calls this function,</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Bomb</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">exploded</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>which toggles the state again, preventing double-fire of the explosion,</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;exploded&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;fontSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;12px&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>then fades the bomb's opacity almost down to nothing</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;opacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">;</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>as with particle, return the prepared constructor function</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">Bomb</span><span class="p">;</span>

    <span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>and again, explicitly make this thing available on window</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">Bomb</span> <span class="o">=</span> <span class="nx">Bomb</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>once more: explosion is a self-executing function expression that
returns a constructor function.
Explosion looks like a bit of cleaned up "main" window-level code;
there are some funny things wedged in here.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Explosion</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="kd">function</span> <span class="nx">Explosion</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>bind callbackable methods so you can pass them cleanly into a setTimeout or whatever</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">tick</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tick</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">dropBomb</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dropBomb</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="kd">var</span> <span class="kr">char</span><span class="p">,</span> <span class="nx">confirmation</span><span class="p">,</span> <span class="nx">style</span><span class="p">,</span> <span class="nx">_ref2</span><span class="p">,</span>
            <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>when you make a new Explosion, bail out here if you've already
loaded one Explosion in the life of the current page.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">FONTBOMB_LOADED</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>if this is the first Explosion call,
set the flag to avoid double-loading</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nb">window</span><span class="p">.</span><span class="nx">FONTBOMB_LOADED</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>idk what this is all abt</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">FONTBOMB_HIDE_CONFIRMATION</span><span class="p">)</span> <span class="nx">confirmation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>keep track of the list of currently live bombs</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">bombs</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>if this.body isn't null (?)</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">((</span><span class="nx">_ref2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>call dropBomb on every click (sadly, including right-clicks, ah well.)
DOM 0 attaching could also be clobbered by any JS code that assigns to
the onclick handler--probably would have been better to do attachEvent()
and addEventListener, if you want to handle IE cleanly.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">_ref2</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">dropBomb</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
                <span class="p">};</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>hey look, a bit of code to handle touch events.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;touchstart&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">touchEvent</span> <span class="o">=</span> <span class="nx">event</span><span class="p">;</span>
            <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>while you're touching and sliding your finger around, moves will keep firing</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;touchmove&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>keep on incrementing the move count</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">_this</span><span class="p">.</span><span class="nx">touchMoveCount</span> <span class="o">||</span> <span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">touchMoveCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">touchMoveCount</span><span class="o">++</span><span class="p">;</span>
            <span class="p">});</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;touchend&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>if you stop touching quickly, drop a bomb where the touch started.
otherwise, you were sliding around the screen, so don't drop a bomb.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">touchMoveCount</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">dropBomb</span><span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">touchEvent</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">touchMoveCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>do something to prepare all the nodes on the page for explosions.
ah, I peeked: we wrap every node and non-whitespace char in <particle> els,
then wrap words in <word> els.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">explosifyNodes</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">chars</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">_j</span><span class="p">,</span> <span class="nx">_len2</span><span class="p">,</span> <span class="nx">_ref3</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>for every <particle> in the document,</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">_ref3</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;particle&#39;</span><span class="p">);</span>
                <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">_j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len2</span> <span class="o">=</span> <span class="nx">_ref3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_j</span> <span class="o">&lt;</span> <span class="nx">_len2</span><span class="p">;</span> <span class="nx">_j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kr">char</span> <span class="o">=</span> <span class="nx">_ref3</span><span class="p">[</span><span class="nx">_j</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>actually create a corresponding Particle object and toss it
into the _results list</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Particle</span><span class="p">(</span><span class="kr">char</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
            <span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>start the animation loop</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">tick</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>if we set confirmation to TRUE above, which I think happens on bookmarklet
launch but not on the fontbomb website,</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">confirmation</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>create a style node and stuff a bunch of fontBomb styles inside it</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">style</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">);</span>
                <span class="nx">style</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;div#fontBombConfirmation {\n  position: absolute;\n  top: -200px;\n  left: 0px;\n  right: 0px;\n  bottom: none;\n  width: 100%;\n  padding: 18px;\n  margin: 0px;\n  background: #e8e8e8;\n  text-align: center;\n  font-size: 14px;\n  line-height: 14px;\n  font-family: verdana, sans-serif;\n  color: #000;\n  -webkit-transition: all 1s ease-in-out;\n  -moz-transition: all 1s ease-in-out;\n  -o-transition: all 1s ease-in-out;\n  -ms-transition: all 1s ease-in-out;\n  transition: all 1s ease-in-out;\n  -webkit-box-shadow: 0px 3px 3px rgba(0,0,0,0.20);\n  -moz-box-shadow: 0px 3px 3px rgba(0,0,0,0.20);\n  box-shadow: 0px 3px 3px rgba(0,0,0,0.20);\n  z-index: 100000002;\n}\ndiv#fontBombConfirmation span {\n  color: #fe3a1a;\n}\ndiv#fontBombConfirmation.show {\n  top:0px;\n  display:block;\n}&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>then append to the document's head (ah, but what if it doesn't have a head? ;-)</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">style</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>create a confirmation div to tell you fontBomb has loaded</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">confirmation</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">confirmation</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;fontBombConfirmation&#39;</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">confirmation</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;span style=&#39;font-weight:bold;&#39;&gt;fontBomb loaded!&lt;/span&gt; Click anywhere to destroy &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>and append it to the body. I sure hope this doesn't execute until
the body is done being parsed--otherwise IE will throw a tasty and
refreshing Operation Aborted error. In the bookmarklet case, it seems
like a pretty safe bet.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">confirmation</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>after 10 msec, show the confirmation</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">confirmation</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;show&#39;</span><span class="p">;</span>
                <span class="p">},</span> <span class="mi">10</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>and hide the confirmation after 5 seconds</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">confirmation</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                <span class="p">},</span> <span class="mi">5000</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>given a set of nodes,</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Explosion</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">explosifyNodes</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">nodes</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">_j</span><span class="p">,</span> <span class="nx">_len2</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span>
            <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">_j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len2</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_j</span> <span class="o">&lt;</span> <span class="nx">_len2</span><span class="p">;</span> <span class="nx">_j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">node</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">_j</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>call downward to each,</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">explosifyNode</span><span class="p">(</span><span class="nx">node</span><span class="p">));</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>then return the list of lists upwards</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="nx">Explosion</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">explosifyNode</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">newNode</span><span class="p">;</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>if it's an element,</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>process its children</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">explosifyNodes</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>if it's a text node,</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>if it doesn't only contain whitespace,</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^\s*$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>if it only has one character in it,</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>set the innerHTML of the text parent to the processed single character</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">explosifyText</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>otherwise it has a bunch of characters,</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>create a new container,</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">newNode</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;particles&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>wrap each of the characters in a particle,</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">newNode</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">explosifyText</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>and replace the text node with the new container</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">newNode</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="nx">Explosion</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">explosifyText</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="kr">char</span><span class="p">,</span> <span class="nx">chars</span><span class="p">,</span> <span class="nx">index</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>split the string, wrap non-whitespace characters in a particle tag,
very clever and nice alternative to using a div with particle class,
which would be a PITA to find all of them on older IE.
anyway, wrap non-whitespace characters in an inline-block displayed
element, so it looks the same, and replace whitespace with non-breaking
space, again, so text on the page looks the same overall.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">chars</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">_len2</span><span class="p">,</span> <span class="nx">_ref2</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span>
                <span class="nx">_ref2</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
                <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len2</span> <span class="o">=</span> <span class="nx">_ref2</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">_len2</span><span class="p">;</span> <span class="nx">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kr">char</span> <span class="o">=</span> <span class="nx">_ref2</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^\s*$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="kr">char</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&lt;particle style=&#39;display:inline-block;&#39;&gt;&quot;</span> <span class="o">+</span> <span class="kr">char</span> <span class="o">+</span> <span class="s2">&quot;&lt;/particle&gt;&quot;</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;&amp;nbsp;&#39;</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
            <span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>re-join the split string</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">chars</span> <span class="o">=</span> <span class="nx">chars</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>re-split the string on non-breaking spaces.
wrap each word (thing not containing whitespace) in a word tag.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">chars</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">_len2</span><span class="p">,</span> <span class="nx">_ref2</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span>
                <span class="nx">_ref2</span> <span class="o">=</span> <span class="nx">chars</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&amp;nbsp;&#39;</span><span class="p">);</span>
                <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len2</span> <span class="o">=</span> <span class="nx">_ref2</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">_len2</span><span class="p">;</span> <span class="nx">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kr">char</span> <span class="o">=</span> <span class="nx">_ref2</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^\s*$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="kr">char</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&lt;word style=&#39;white-space:nowrap&#39;&gt;&quot;</span> <span class="o">+</span> <span class="kr">char</span> <span class="o">+</span> <span class="s2">&quot;&lt;/word&gt;&quot;</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kr">char</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
            <span class="p">})();</span>
            <span class="k">return</span> <span class="nx">chars</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>here's your 'main' method. when a click occurs, the event is passed
into dropBomb, which gets the x,y click coords from findClickPos, which
we created and oddly tagged onto the window object way up at the top.
then, you push the click coords onto the bombs queue.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Explosion</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dropBomb</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pos</span><span class="p">;</span>
            <span class="nx">pos</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">findClickPos</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">bombs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Bomb</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">));</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>on tick, the state of the animation advances.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Explosion</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">tick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">bomb</span><span class="p">,</span> <span class="kr">char</span><span class="p">,</span> <span class="nx">_j</span><span class="p">,</span> <span class="nx">_k</span><span class="p">,</span> <span class="nx">_l</span><span class="p">,</span> <span class="nx">_len2</span><span class="p">,</span> <span class="nx">_len3</span><span class="p">,</span> <span class="nx">_len4</span><span class="p">,</span> <span class="nx">_ref2</span><span class="p">,</span> <span class="nx">_ref3</span><span class="p">,</span> <span class="nx">_ref4</span><span class="p">;</span>
            <span class="nx">_ref2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bombs</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>loop over all the bombs.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="nx">_j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len2</span> <span class="o">=</span> <span class="nx">_ref2</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_j</span> <span class="o">&lt;</span> <span class="nx">_len2</span><span class="p">;</span> <span class="nx">_j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">bomb</span> <span class="o">=</span> <span class="nx">_ref2</span><span class="p">[</span><span class="nx">_j</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>if the bomb's state just advanced to 'explose',</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">bomb</span><span class="p">.</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;explose&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>call exploded() to mark the bomb as handled,</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">bomb</span><span class="p">.</span><span class="nx">exploded</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>then set blast position to the coords of the currently-exploding bomb.
looks like this will cause 2 simultaneously exploding bombs
to only show one blast on the page, which probably is a fine
visual experience, and keeps calculations within a frame simple.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">this</span><span class="p">.</span><span class="nx">blast</span> <span class="o">=</span> <span class="nx">bomb</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>if something just exploded,</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">blast</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">_ref3</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">chars</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>update all the chars on the page, passing them the blast info.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">for</span> <span class="p">(</span><span class="nx">_k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len3</span> <span class="o">=</span> <span class="nx">_ref3</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_k</span> <span class="o">&lt;</span> <span class="nx">_len3</span><span class="p">;</span> <span class="nx">_k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kr">char</span> <span class="o">=</span> <span class="nx">_ref3</span><span class="p">[</span><span class="nx">_k</span><span class="p">];</span>
                    <span class="kr">char</span><span class="p">.</span><span class="nx">tick</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">blast</span><span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>then null out the blast, since it's been processed</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">blast</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>if nothing exploded,</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>update all the chars in the page, but don't pass any args into tick.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">_ref4</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">chars</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">_l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len4</span> <span class="o">=</span> <span class="nx">_ref4</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_l</span> <span class="o">&lt;</span> <span class="nx">_len4</span><span class="p">;</span> <span class="nx">_l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kr">char</span> <span class="o">=</span> <span class="nx">_ref4</span><span class="p">[</span><span class="nx">_l</span><span class="p">];</span>
                    <span class="kr">char</span><span class="p">.</span><span class="nx">tick</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>end the tick() method by calling tick() again after a short delay.
this causes the animation loop to run forever.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tick</span><span class="p">);</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>finally, return the prepared constructor, even though it's really a singleton</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">Explosion</span><span class="p">;</span>

    <span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>end by creating the Explosion singleton, which will prepare the page, by
wrapping everything in <particle>s, and then start the animation loop</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">new</span> <span class="nx">Explosion</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>&amp; voila! it is done.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 