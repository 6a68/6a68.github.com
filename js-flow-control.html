<!DOCTYPE html>  <html> <head>   <title>js-flow-control.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> <script type="text/javascript">   if (window.location.hostname != '6a68.net') { return; }    var _gaq = _gaq || [];   _gaq.push(['_setAccount', 'UA-32602307-1']);   _gaq.push(['_trackPageview']);    (function() {     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);   })();  </script> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="code-equals-data-equals-code.html">                 code-equals-data-equals-code.js               </a>                                           <a class="source" href="fontbomb.html">                 fontbomb.js               </a>                                           <a class="source" href="frontend-architecture-patterns.html">                 frontend-architecture-patterns.js               </a>                                           <a class="source" href="functional-programming.html">                 functional-programming.js               </a>                                           <a class="source" href="index.html">                 index.js               </a>                                           <a class="source" href="interview-problems-dependency-manager.html">                 interview-problems-dependency-manager.js               </a>                                           <a class="source" href="js-flow-control.html">                 js-flow-control.js               </a>                                           <a class="source" href="meebo-jquery.html">                 meebo-jquery.js               </a>                                           <a class="source" href="reentrant-exceptions.html">                 reentrant-exceptions.js               </a>                                           <a class="source" href="rsvp.html">                 rsvp.js               </a>                                           <a class="source" href="theres-a-bluebird-in-my-heart.html">                 theres-a-bluebird-in-my-heart.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>first pass.</p>

<h1>Flow control</h1>

<p>Doing the thing. Same thing on client and server.</p>

<h3>1. Flow control options</h3>

<ul>
<li>node-style callbacks (continuation passing style)</li>
<li>promises</li>
<li>deferreds</li>
<li>pub-sub (publishing and subscribing to events)
<ul><li>single global event registry</li>
<li>subscribe to events directly on objects of interest (old-skool Observer pattern)</li></ul></li>
</ul>

<h3>2. Some examples to motivate comparison</h3>

<p>Hoepfully pull these from the browserid codebase</p>

<h3>3. Pros and Cons of each approach applied to each example</h3>

<p>There's no one right answer for every case. But we can pare down to 2-3 options to use everywhere. This makes our codebase so much easier to read.</p>

<h3>4. Wrapping up: which to use, when</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>second pass. I'm tired of putting stuff in gists.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*  TODO: add some code examples alongside the exposition as we flesh it out. */</span>

<span class="cm">/* a couple functions to get us started. */</span>
<span class="cm">/* TODO I really don&#39;t think this is a good set of functions for examples.</span>
<span class="cm">        Maybe we can get more realistic examples. let&#39;s look at other libs. */</span>
<span class="kd">function</span> <span class="nx">generateNum</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">3</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">generateDenom</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">5</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">divide</span><span class="p">(</span><span class="nx">num</span><span class="p">,</span> <span class="nx">denom</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">num</span><span class="o">/</span><span class="nx">denom</span> <span class="p">}</span>

<span class="cm">/* why division? because you need num and denom to divide, or you&#39;ll get</span>
<span class="cm">   weird errors. */</span>

<span class="cm">/* we&#39;ll need an error detection function. note, 2/0 = Infinity in JS. */</span>
<span class="kd">function</span> <span class="nx">isNum</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">n</span> <span class="o">==</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">isFinite</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">}</span>

<span class="cm">/* then what? */</span>
<span class="kd">function</span> <span class="nx">divideThrower</span><span class="p">(</span><span class="nx">num</span><span class="p">,</span> <span class="nx">denom</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isNum</span><span class="p">(</span><span class="nx">num</span><span class="p">))</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;numerator is not a number&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isNum</span><span class="p">(</span><span class="nx">denom</span><span class="p">))</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;denominator is not a number&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">num</span><span class="o">/</span><span class="nx">denom</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isNum</span><span class="p">(</span><span class="nx">result</span><span class="p">))</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;result is not a number&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Flow control in JS.</h2>

<ul>
<li>callbacks, including node-style.
<ul><li>jQuery leads to this too: nested callbacks.</li>
<li>this does not scale, is hard to change later, hard to handle errors/exceptions, hard to pass args to inner cbs (have to add args to inner cb's signature or use global state).</li>
<li><strong>most tightly-coupled. easiest to use quickly.</strong></li></ul></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <ul>
<li><p>pubsub</p>

<ul><li>a few variations here.</li>
<li>client-side only: publish custom events in DOM.</li>
<li>this lets parent nodes listen for custom events fired by child nodes that are dynamically-created.</li>
<li>requires a DOM</li>
<li>penalty to go JS -> DOM -> JS: several ticks of the event loop.</li>
<li>works for apps that use jQuery-style "the DOM is the data store" approach</li>
<li>forget this for us (we want the same system server + client), just being complete.</li>
<li>observer pattern.</li>
<li>2 variations:</li>
<li><strong>global event broker</strong>
<ul><li>every object subs + pubs on a global.</li>
<li>extremely late-bound: objs created later can be observed indirectly by objects created earlier</li>
<li>OTOH: no guarantee an event will ever get fired, you might typo it, etc</li></ul></li>
<li><strong>direct observer</strong>
<ul><li>every object has publishing powers, objs observe each other directly</li>
<li>have to initialize all objects first, in order to wire up listeners.</li>
<li>this can be mitigated using queues or deferreds:</li>
<li>objq = list of [subscriber, 'signal']</li>
<li>onObjReady = deferred. fires when obj is ready, then you subscribe:
onObjReady.then(function(obj) {
obj.on('whatever', bind(otherObj, otherObj.onWhateverFired) 
})</li></ul></li></ul></li>
<li><p>deferreds: lightweight broker of CBs</p>

<ul><li>when(x) do (a bunch of things at once)</li>
<li>if x is already ready, just do stuff right away.</li>
<li>if you get an error instead of success?</li>
<li>either subscribe to failure state separately</li>
<li>or handle the 2 cases inside the single registered callback</li></ul></li>
<li>promises: lightweight sequencer of CBs
<ul><li>when(x) then(y)</li>
<li>'then' returns a new promise, so it's chainable:</li>
<li>when(x).then(y).then(z)</li>
<li>can subscribe a single error handler within a flow:
when(x).then(y).err(handleXAndYErrors).then(z)</li></ul></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 